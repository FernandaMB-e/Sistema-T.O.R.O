<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>T.O.R.O - Sistema Estudiantil</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="icon" href="assets/logo_toro.png">
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --bg-light: #F8F9FA;
            --modal-blue: #2b59a2;
            --color-header-text: #1a8f3d; 
            --color-text-blue: #3b5998;
            --bg-lesson-container: #dcece2;
            --border-lesson-container: #8ebf9e;
            --btn-green-bg: #619b6b;
            --btn-gray-bg: #637388;
        }
        * { box-sizing: border-box; }
        body { 
            background-color: var(--bg-light); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 0;
        }
        
        .login-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 2rem; 
            text-align: center; 
            min-height: 100vh;
        }

        .mobile-container {
            background-color: white; 
            width: 100%; 
            max-width: 380px;
            border-radius: 20px; 
            padding: 30px 20px; 
            margin: 20px auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            text-align: center;
        }

        .welcome-box {
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 6px;
            color: #444;
        }
        .welcome-text { font-size: 18px; font-weight: 400; }
        .user-name { font-size: 18px; font-weight: 700; }

        .course-title-container { margin-bottom: 30px; }
        .course-label { 
            font-size: 11px; 
            color: #aaa; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            display: block; 
            margin-bottom: 6px; 
        }
        .course-name { 
            color: var(--dark-green); 
            font-size: 22px; 
            font-weight: 800; 
            display: inline-block; 
        }
        .thin-line { 
            border: 0; 
            height: 1px; 
            background: #e0e0e0; 
            width: 80%; 
            margin: 12px auto 0; 
        }

        .lesson-container { 
            background: var(--bg-lesson-container); 
            border: 1px solid var(--border-lesson-container); 
            border-radius: 20px; 
            padding: 25px 15px; 
            margin-bottom: 10px; 
        }
        .lesson-card { 
            background: white; 
            border-radius: 10px; 
            padding: 12px 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .upload-area { 
            border: 2px dashed #ccc; 
            border-radius: 15px; 
            padding: 20px; 
            margin: 15px 0; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .info-text { 
            font-size: 12px; 
            color: #666; 
            margin: 15px 0 5px 0; 
        }

        .test-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin: 15px 0; 
        }
        .btn-test { 
            background: white; 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 15px; 
            font-size: 12px; 
            cursor: pointer; 
            color: #333;
            transition: all 0.2s;
        }
        .btn-test:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .modal-content { 
            background: white; 
            width: 90%; 
            max-width: 350px; 
            border-radius: 25px; 
            overflow: hidden; 
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { 
            padding: 30px 20px; 
            color: white; 
            background-color: var(--modal-blue); 
        }
        .score-value { 
            font-size: 3.5rem; 
            font-weight: 900; 
            margin: 10px 0; 
        }
        .text-green { color: #2e7d32; } 
        .text-orange { color: #f9a825; } 
        .text-red { color: #c62828; }
        .hidden { display: none; }
        
        .btn-toro { 
            border: none; 
            padding: 12px; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            color: white; 
            margin-bottom: 10px;
            transition: opacity 0.2s;
        }
        .btn-toro:hover {
            opacity: 0.9;
        }
        
        #lesson-viewer-content, 
        #actividad-viewer-content { 
            padding: 20px; 
            text-align: left; 
            max-height: 60vh; 
            overflow-y: auto; 
        }

        .question-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .option-btn:hover {
            background: #f0f0f0;
            border-color: var(--modal-blue);
        }
        .option-btn.selected {
            background: #e3f2fd;
            border-color: var(--modal-blue);
        }

        .alert {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
    </style>
</head>
<body>

    <div id="main-content"></div>

    <!-- Modal de confirmaciÃ³n/resultado -->
   <div id="modal-container" class="modal-overlay">
    <div class="modal-content" style="border-radius: 30px; overflow: hidden; border: none; max-width: 450px;">
        
        <div id="modal-header-bg" class="modal-header" style="background-color: #2b59a2; padding: 40px 20px; text-align: center; color: white;">
            <div id="modal-icon" style="margin-bottom: 15px; font-size: 3rem;">
                <i class="fas fa-award"></i> 
            </div>
            <h2 id="modal-title" style="font-size: 1.6rem; margin: 0; font-weight: 600; line-height: 1.2;"></h2>
        </div>

        <div class="modal-body" style="padding: 30px; text-align: center;">
            
            <div id="score-section" class="hidden">
                <p style="color: #888; margin: 0; font-size: 1.1rem;">Puntaje obtenido:</p>
                <div id="score-number" style="font-size: 5rem; font-weight: 900; margin: 5px 0; line-height: 1;"></div>
                <p id="intentos-info" style="color: #444; margin-top: 10px; font-size: 0.95rem;"></p>
            </div>

            <p id="modal-text-inicio" style="color: #555; font-size: 1.1rem; margin-bottom: 20px;"></p>
            <p id="modal-text" class="hidden"></p>

            <div id="modal-footer-btns" style="display: flex; gap: 15px; margin-top: 25px;">
                <button id="btn-izq" class="btn-toro" 
                        style="background-color: #637388; width: 50%; color: white; border-radius: 20px; padding: 12px; border: none; font-weight: bold; cursor: pointer;" 
                        onclick="volverALeccion()">
                    Volver
                </button>
                
                <button id="btn-der" class="btn-toro" 
                        style="background-color: #619b6b; width: 50%; color: white; border-radius: 20px; padding: 12px; border: none; font-weight: bold; cursor: pointer;" 
                        onclick="aceptarEIrAActividad()">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal de contenido-->
    <div id="lesson-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 90%;">
            <div id="lesson-viewer-content"></div>
            <p class="info-text" style="margin-bottom: 5px;">"Pulsa para ir a la actividad calificable"</p>
            <button class="btn-toro" style="background: var(--btn-green-bg); width: 80%; margin: 15px auto; display: block;" onclick="iniciarActividadDesdeLeccion()">Continuar a Actividad</button>
        </div>
    </div>

    <!-- Modal de actividad -->
    <div id="actividad-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 90%; min-height: 40vh;">
            <div id="actividad-viewer-content">
                <h2 style="text-align: center; color: var(--modal-blue); margin-top: 20px;">Actividad en curso</h2>
                <p style="text-align: center; color: #888;">Cargando actividad...</p>
            </div>
            <button class="btn-toro" id="btn-finalizar-actividad" style="background: var(--btn-gray-bg); width: 80%; margin: 15px auto; display: block;" onclick="finalizarActividad()">Enviar Respuestas</button>
        </div>
    </div>


    <script src="jszip.min.js"></script>


    <script>
        //============== SERVIDOR SW =====================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log(' Service Worker registrado:', reg.scope))
            .catch(err => console.error(' Error al registrar SW:', err));
    });
}

// ========== VARIABLES GLOBALES ==========
let leccionesMemoria = JSON.parse(localStorage.getItem('toro_lecciones_html')) || [];
let leccionActual = null;
window.toro_recursos = {}; // Almacena los Blobs de imÃ¡genes

// ========== VISTA ESTUDIANTE ==========
function mostrarVistaEstudiante(nombre) {
    const root = document.getElementById('main-content');
    root.innerHTML = `
        <div class="mobile-container">
            <div class="welcome-box">
                <span class="welcome-text">Â¡Hola!</span>
                <span class="user-name">${nombre}</span>
            </div>
            
            <div class="course-title-container">
                <span class="course-label">EstÃ¡s en el curso de</span>
                <div class="course-name">Cultura digital I</div>
                <hr class="thin-line">
            </div>
            
            <h2 style="color: var(--color-text-blue); font-size: 15px; text-align: left; margin-bottom: 10px;">Lecciones disponibles</h2>
            <div id="contenedor-lecciones" class="lesson-container"></div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

            <h2 style="color: var(--color-text-blue); font-size: 15px; text-align: left;">Importar nuevas lecciones</h2>
            <div class="upload-area">
                <span style="font-size: 35px; margin-bottom: 10px;">ðŸ“‚</span>
                <input type="file" id="fileInput" accept=".zip" hidden onchange="actualizarNombreArchivo(this)">
                <button class="btn-toro" style="background: #e3f2fd; color: #1976d2; border: 1px dashed #1976d2;" onclick="document.getElementById('fileInput').click()">Seleccionar ZIP</button>
                <div id="file-status" style="font-size: 11px; margin-top: 8px; color: #888;">NingÃºn archivo seleccionado</div>
            </div>

            <p class="info-text">"Pulsa para cargar las lecciones"</p>
            <button class="btn-toro" style="background: var(--btn-green-bg);" onclick="procesarHTML()">Cargar archivos</button>

            <p class="info-text">"Pulsa para ingresar tus datos de nuevo"</p>
            <button class="btn-toro" style="background: var(--btn-gray-bg);" onclick="cerrarSesion()">Cambiar de usuario</button>
        </div>
    `;
    renderizarLecciones();
}

function actualizarNombreArchivo(input) {
    const statusDiv = document.getElementById('file-status');
    if (input.files[0]) {
        statusDiv.innerText = ` ${input.files[0].name}`;
        statusDiv.style.color = '#2e7d32';
    }
}

function renderizarLecciones() {
    const contenedor = document.getElementById('contenedor-lecciones');
    if (!contenedor) return;
    contenedor.innerHTML = ""; // Limpiar antes de renderizar

    leccionesMemoria.forEach((lec, index) => {
        const card = document.createElement('div');
        card.className = 'lesson-card';
        card.onclick = () => verLeccionImportada(index);
        card.innerHTML = `
            <span>ðŸ“– ${lec.titulo}</span> 
            <div style="height: 10px; width: 10px; background-color: var(--modal-blue); border-radius: 50%;"></div>
        `;
        contenedor.appendChild(card);
    });
}

function verLeccionImportada(index) {
    const leccion = leccionesMemoria[index];
    leccionActual = leccion;

    const contenedor = document.getElementById('lesson-viewer-content');
    contenedor.innerHTML = leccion.html;

    // Reparar imÃ¡genes
    const imagenes = contenedor.querySelectorAll('img');
    imagenes.forEach(img => {
        const srcOriginal = img.getAttribute('src');
        const nombreLimpio = srcOriginal.replace('./', ''); 
        const rutaConCarpeta = leccion.rutaBase + nombreLimpio;
        const blobUrl = window.toro_recursos[nombreLimpio] || 
                        window.toro_recursos[rutaConCarpeta] || 
                        window.toro_recursos[srcOriginal];

        if (blobUrl) img.src = blobUrl;
    });

    document.getElementById('lesson-modal').style.display = 'flex';
}

// ========== FLUJO DE ACTIVIDAD ==========

function iniciarActividadDesdeLeccion() {
    document.getElementById('lesson-modal').style.display = 'none';
    abrirModal('inicio');
}

function aceptarEIrAActividad() {
    document.getElementById('modal-container').style.display = 'none';
    if (leccionActual && leccionActual.html) {
        mostrarActividad();
    } else {
        alert("Error: No se encontrÃ³ el contenido de la actividad.");
    }
}

function mostrarActividad() {
    const contenedor = document.getElementById('actividad-viewer-content');
    document.getElementById('actividad-modal').style.display = 'flex';
    document.getElementById('actividad-modal').scrollTop = 0;

    contenedor.innerHTML = leccionActual.html;

    // 1. Reparar ImÃ¡genes en el modal de actividad
    const imagenes = contenedor.querySelectorAll('img');
    imagenes.forEach(img => {
        const srcOriginal = img.getAttribute('src');
        const nombreLimpio = srcOriginal.replace('./', ''); 
        const rutaConCarpeta = leccionActual.rutaBase + nombreLimpio;
        const blobUrl = window.toro_recursos[nombreLimpio] || window.toro_recursos[rutaConCarpeta];
        if (blobUrl) img.src = blobUrl;
    });

    // 2. Saltar directamente al cuestionario
    const secLectura = contenedor.querySelector('#lectura');
    const secQuiz = contenedor.querySelector('#quiz');
    const tabsProfesor = contenedor.querySelector('.tabs');
    if (secLectura) secLectura.style.display = 'none';
    if (tabsProfesor) tabsProfesor.style.display = 'none';
    if (secQuiz) {
        secQuiz.style.display = 'block';
        secQuiz.classList.add('active');
    }

    // 3. Ocultar botÃ³n verde original del profesor
    const btnProfesor = contenedor.querySelector('.btn');
    if (btnProfesor) btnProfesor.style.display = 'none';

    // 4. Configurar el botÃ³n GRIS (Finalizar Actividad)
    const btnToro = document.getElementById('btn-finalizar-actividad');
    btnToro.onclick = function() {
        const respuestasProfe = leccionActual.respuestasCorrectas || [];
        let aciertos = 0;
        let respondidas = 0;

        respuestasProfe.forEach((res, i) => {
            const radio = contenedor.querySelector(`input[name="p${i+1}"]:checked`);
            if (radio) {
                respondidas++;
                if (radio.value.trim().toLowerCase() === res.trim().toLowerCase()) aciertos++;
            }
        });

        if (respondidas < respuestasProfe.length) {
            alert("âš ï¸ Por favor, responde todas las preguntas antes de finalizar.");
            return;
        }

        const notaFinal = (aciertos / respuestasProfe.length) * 10;
        
        // Guardar en historial
        let historial = JSON.parse(localStorage.getItem('toro_historial')) || {};
        if (!historial[leccionActual.titulo]) historial[leccionActual.titulo] = [];
        historial[leccionActual.titulo].push(notaFinal);
        localStorage.setItem('toro_historial', JSON.stringify(historial));

        document.getElementById('actividad-modal').style.display = 'none';
        abrirModal('resultado', notaFinal);
    };
}

// ========== SISTEMA DE MODALES UNIFICADO ==========

function abrirModal(tipo, puntos = 0) {
    const modal = document.getElementById('modal-container');
    const title = document.getElementById('modal-title');
    const scoreNum = document.getElementById('score-number');
    const scoreSec = document.getElementById('score-section');
    const intentosInfo = document.getElementById('intentos-info');
    const modalTextInicio = document.getElementById('modal-text-inicio');
    const btnIzq = document.getElementById('btn-izq');
    const btnDer = document.getElementById('btn-der');
    
    modal.style.display = 'flex';

    const historial = JSON.parse(localStorage.getItem('toro_historial')) || {};
    const intentosHechos = (historial[leccionActual.titulo] || []);
    const limiteMax = leccionActual.intentosMax || 3;
    const restantes = limiteMax - intentosHechos.length;

    if (tipo === 'inicio') {
        title.innerText = "Â¿Te sientes listo para poner a prueba lo aprendido?";
        scoreSec.classList.add('hidden');
        modalTextInicio.classList.remove('hidden');
        modalTextInicio.innerText = `Este es tu intento ${intentosHechos.length + 1} de ${limiteMax}. Una vez que comiences, no podrÃ¡s volver atrÃ¡s.`;
        
        btnIzq.innerText = "Volver";
        btnIzq.onclick = () => { modal.style.display = 'none'; };
        btnDer.innerText = "Aceptar";
        btnDer.onclick = () => { aceptarEIrAActividad(); };

    } else if (tipo === 'resultado') {
        const nombre = localStorage.getItem('toro_nombre') || "Estudiante";
        title.innerText = `Â¡${puntos >= 6 ? 'Buen trabajo' : 'Puedes mejorar'}, ${nombre}!`;
        
        scoreSec.classList.remove('hidden');
        modalTextInicio.classList.add('hidden');
        
        scoreNum.innerText = `${puntos.toFixed(1)}/10`;
        scoreNum.style.color = puntos >= 6 ? '#2e7d32' : '#c62828';
        intentosInfo.innerHTML = `NÃºmero de intentos disponibles: <span style="color: #2e7d32; font-weight: bold;">${restantes}</span>`;

        btnIzq.innerText = "Reintentar";
        btnIzq.style.display = restantes > 0 ? "block" : "none";
        btnIzq.onclick = () => { abrirModal('inicio'); };
        
        btnDer.innerText = "Finalizar";
        btnDer.onclick = () => {
            const mat = localStorage.getItem('toro_matricula') || "0000";
            let cuerpo = `REPORTE CONSOLIDADO T.O.R.O\n\nESTUDIANTE: ${nombre}\nMATRÃCULA: ${mat}\nLECCIÃ“N: ${leccionActual.titulo}\n\n`;
            intentosHechos.forEach((nota, i) => cuerpo += `Intento ${i + 1}: ${nota.toFixed(1)}/10\n`);
            
            const promedio = (intentosHechos.reduce((a, b) => a + b, 0) / intentosHechos.length).toFixed(2);
            cuerpo += `\nPROMEDIO FINAL: ${promedio}/10`;

            descargarArchivoTxt(cuerpo, `Reporte_${mat}_${leccionActual.titulo.replace(/\s+/g, '_')}.txt`);
            modal.style.display = 'none';
        };
    }
}

// ========== PROCESAMIENTO ZIP ==========

async function procesarHTML() {
    const input = document.getElementById('fileInput');
    if (!input.files[0]) return;

    try {
        const file = input.files[0];
        const arrayBuffer = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);
        
        let htmlOriginal = "";
        let rutaHtml = "";
        let intentosTxt = 3;
        let respuestasTxt = [];

        const promesas = [];
        zip.forEach((rutaCompleta, entry) => {
            if (!entry.dir) {
                const p = entry.async("blob").then(async blob => {
                    window.toro_recursos[rutaCompleta] = URL.createObjectURL(blob);
                    if (rutaCompleta.endsWith('.txt')) {
                        const texto = await blob.text();
                        const mInt = texto.match(/INTENTOS_MAX:\s*(\d+)/);
                        if (mInt) intentosTxt = parseInt(mInt[1]);
                        const mResp = [...texto.matchAll(/RESPUESTA:\s*([a-c])/g)];
                        respuestasTxt = mResp.map(m => m[1]);
                    }
                });
                promesas.push(p);
                if (rutaCompleta.endsWith('.html')) rutaHtml = rutaCompleta;
            }
        });

        await Promise.all(promesas);
        htmlOriginal = await zip.file(rutaHtml).async("string");

        const leccionNueva = {
            titulo: file.name.replace('.zip', ''),
            html: htmlOriginal, 
            rutaBase: rutaHtml.substring(0, rutaHtml.lastIndexOf('/') + 1),
            intentosMax: intentosTxt,
            respuestasCorrectas: respuestasTxt
        };

        leccionesMemoria.push(leccionNueva);
        localStorage.setItem('toro_lecciones_html', JSON.stringify(leccionesMemoria));
        renderizarLecciones();
        alert(`âœ… Importado: ${leccionNueva.titulo}`);

    } catch (e) {
        console.error(e);
        alert("Error procesando el ZIP");
    }
}

// ========== UTILIDADES ==========

function descargarArchivoTxt(contenido, nombreArchivo) {
    const elemento = document.createElement('a');
    const archivo = new Blob([contenido], {type: 'text/plain'});
    elemento.href = URL.createObjectURL(archivo);
    elemento.download = nombreArchivo;
    document.body.appendChild(elemento);
    elemento.click();
    document.body.removeChild(elemento);
}

function volverALeccion() {
    document.getElementById('modal-container').style.display = 'none';
}

function cerrarSesion() {
    if(confirm("Â¿EstÃ¡s seguro? Se eliminarÃ¡n tus datos y lecciones importadas.")){
        localStorage.clear();
        location.reload();
    }
}

function mostrarLogin() {
    document.getElementById('main-content').innerHTML = `
        <div class="login-container">
            <h1 style="font-size: 3rem; color: #33691E; font-weight: 900;">T.O.R.O</h1>
            <form id="loginForm">
                <input type="text" id="matricula" placeholder="MatrÃ­cula" required style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ccc;">
                <input type="text" id="nombre" placeholder="Nombre completo" required style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ccc;">
                <button type="submit" class="btn-toro" style="background:#689F38; color:white; width:100%;">Continuar</button>
            </form>
        </div>
    `;
    document.getElementById('loginForm').onsubmit = (e) => {
        e.preventDefault();
        const nom = document.getElementById('nombre').value;
        const mat = document.getElementById('matricula').value;
        localStorage.setItem('toro_nombre', nom);
        localStorage.setItem('toro_matricula', mat);
        localStorage.setItem('toro_datos_listos', 'true');
        mostrarVistaEstudiante(nom);
    };
}

window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('toro_datos_listos') === 'true') {
        mostrarVistaEstudiante(localStorage.getItem('toro_nombre'));
    } else {
        mostrarLogin();
    }
});
    </script>

    
</body>
</html>